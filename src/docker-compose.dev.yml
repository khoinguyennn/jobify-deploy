version: '3.8'

# ==================================
# Jobify - Development Environment
# ==================================

services:
  # MySQL Database
  database:
    image: mysql:8.0
    container_name: jobify-database-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: jobify_db
      MYSQL_USER: jobify_user
      MYSQL_PASSWORD: jobify_password
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - db_data_dev:/var/lib/mysql
      - ./database:/docker-entrypoint-initdb.d:ro
    networks:
      - jobify-network-dev
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "jobify_user", "-pjobify_password"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 40s

  # Express.js Server (Development)
  server:
    build: 
      context: ./server
      dockerfile: Dockerfile
      target: deps  # Use deps stage for development with hot reload
    container_name: jobify-server-dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: 5000
      # Database
      DB_HOST: database
      DB_PORT: 3306
      DB_NAME: jobify_db
      DB_USER: jobify_user
      DB_PASSWORD: jobify_password
      # JWT & Security
      JWT_SECRET: dev-jwt-secret-key-not-for-production
      BCRYPT_ROUNDS: 10
      # CORS
      FRONTEND_URL: http://localhost:3000
      # AI Integration (Optional in dev)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    ports:
      - "5000:5000"
    volumes:
      - ./server:/app:delegated
      - server_uploads_dev:/app/uploads
      - /app/node_modules  # Anonymous volume for node_modules
    networks:
      - jobify-network-dev
    depends_on:
      database:
        condition: service_healthy
    command: npm run dev

  # Next.js Client (Development)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: deps  # Use deps stage for development
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:5000/api
        - NEXT_PUBLIC_BACKEND_URL=http://localhost:5000
    container_name: jobify-client-dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: 3000
      NEXT_PUBLIC_API_URL: http://localhost:5000/api
      NEXT_PUBLIC_BACKEND_URL: http://localhost:5000
    ports:
      - "3000:3000"
    volumes:
      - ./client:/app:delegated
      - /app/node_modules  # Anonymous volume for node_modules
      - /app/.next  # Anonymous volume for .next
    networks:
      - jobify-network-dev
    depends_on:
      server:
        condition: service_started
    command: npm run dev

# Volumes for development data
volumes:
  db_data_dev:
    name: jobify-db-data-dev
    driver: local
  server_uploads_dev:
    name: jobify-server-uploads-dev
    driver: local

# Network for development
networks:
  jobify-network-dev:
    name: jobify-network-dev
    driver: bridge


















